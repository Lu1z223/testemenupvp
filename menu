-- ========================
-- CONFIGURAÇÕES DO ESP
-- ========================
local Settings = {
    MenuVisible = true,
    ESPVisible = false,
    BoxEnabled = true,
    LineEnabled = true,
    TeamCheck = true,
    BoxColor = Color3.fromRGB(255,0,0),
    LineColor = Color3.fromRGB(255,0,0),
    BoxThickness = 1,
    LineThickness = 1
}

-- ========================
-- GUI
-- ========================
local ScreenGui = Instance.new("ScreenGui", game.CoreGui)
ScreenGui.Name = "ESPMenu"

local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(0, 220, 0, 200)
Frame.Position = UDim2.new(0,50,0,50)
Frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
Frame.Active = true
Frame.Draggable = true

local function CreateButton(text, posY, callback)
    local btn = Instance.new("TextButton", Frame)
    btn.Size = UDim2.new(1, -10, 0, 25)
    btn.Position = UDim2.new(0,5,0,posY)
    btn.Text = text
    btn.BackgroundColor3 = Color3.fromRGB(50,50,50)
    btn.TextColor3 = Color3.new(1,1,1)
    btn.MouseButton1Click:Connect(callback)
    return btn
end

-- Botão para mostrar/ocultar ESP
CreateButton("ESP", 5, function()
    Settings.ESPVisible = not Settings.ESPVisible
end)

-- Botão para fechar menu
CreateButton("Fechar Menu", 35, function()
    Settings.MenuVisible = false
end)

-- Botão reaparecer menu (fora do Frame)
local ShowButton = Instance.new("TextButton", ScreenGui)
ShowButton.Size = UDim2.new(0,100,0,30)
ShowButton.Position = UDim2.new(0,20,0,20)
ShowButton.Text = "Mostrar Menu"
ShowButton.BackgroundColor3 = Color3.fromRGB(50,50,50)
ShowButton.TextColor3 = Color3.new(1,1,1)
ShowButton.Visible = false
ShowButton.MouseButton1Click:Connect(function()
    Settings.MenuVisible = true
    ShowButton.Visible = false
end)

-- Atualiza visibilidade do menu
game:GetService("RunService").RenderStepped:Connect(function()
    Frame.Visible = Settings.MenuVisible
    ShowButton.Visible = not Settings.MenuVisible
end)

-- ========================
-- Checkboxes de ESP
-- ========================
local CheckStartY = 70
local function CreateCheckbox(text, posY, settingName)
    local cb = Instance.new("TextButton", Frame)
    cb.Size = UDim2.new(1, -10, 0, 25)
    cb.Position = UDim2.new(0,5,0,posY)
    cb.Text = text .. " [ON]"
    cb.BackgroundColor3 = Color3.fromRGB(50,50,50)
    cb.TextColor3 = Color3.new(1,1,1)
    cb.Visible = false
    cb.MouseButton1Click:Connect(function()
        Settings[settingName] = not Settings[settingName]
        cb.Text = text .. (Settings[settingName] and " [ON]" or " [OFF]")
    end)
    return cb
end

local ESPBoxCB = CreateCheckbox("ESP Box", CheckStartY, "BoxEnabled")
local ESPLineCB = CreateCheckbox("ESP Linha", CheckStartY + 30, "LineEnabled")
local TeamCheckCB = CreateCheckbox("Team Check", CheckStartY + 60, "TeamCheck")

-- Atualiza visibilidade dos checkboxes
game:GetService("RunService").RenderStepped:Connect(function()
    ESPBoxCB.Visible = Settings.ESPVisible
    ESPLineCB.Visible = Settings.ESPVisible
    TeamCheckCB.Visible = Settings.ESPVisible
end)

-- ========================
-- FUNÇÃO DE ESP
-- ========================
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local ESPObjects = {}

local function CreateESP(player)
    if player == LocalPlayer then return end
    local box = Drawing.new("Square")
    box.Thickness = Settings.BoxThickness
    box.Filled = false
    box.Color = Settings.BoxColor

    local line = Drawing.new("Line")
    line.Thickness = Settings.LineThickness
    line.Color = Settings.LineColor

    ESPObjects[player] = {Box = box, Line = line}
end

for _, plr in pairs(Players:GetPlayers()) do
    CreateESP(plr)
end
Players.PlayerAdded:Connect(CreateESP)

RunService.RenderStepped:Connect(function()
    for player, objects in pairs(ESPObjects) do
        local char = player.Character
        if not char or not char:FindFirstChild("HumanoidRootPart") or not char:FindFirstChild("Humanoid") then
            objects.Box.Visible = false
            objects.Line.Visible = false
            continue
        end

        if Settings.TeamCheck and player.Team == LocalPlayer.Team then
            objects.Box.Visible = false
            objects.Line.Visible = false
            continue
        end

        local root = char.HumanoidRootPart
        local head = char:FindFirstChild("Head")
        local rootPos, onScreen = Camera:WorldToViewportPoint(root.Position)
        local headPos = Camera:WorldToViewportPoint(head.Position + Vector3.new(0,0.5,0))
        local footPos = Camera:WorldToViewportPoint(root.Position - Vector3.new(0,3,0))

        if onScreen then
            if Settings.BoxEnabled then
                local width = (2000 / rootPos.Z)
                local height = headPos.Y - footPos.Y
                objects.Box.Size = Vector2.new(width, height)
                objects.Box.Position = Vector2.new(rootPos.X - width/2, rootPos.Y - height/2)
                objects.Box.Color = Settings.BoxColor
                objects.Box.Visible = true
            else
                objects.Box.Visible = false
            end

            if Settings.LineEnabled then
                objects.Line.From = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y)
                objects.Line.To = Vector2.new(rootPos.X, rootPos.Y)
                objects.Line.Color = Settings.LineColor
                objects.Line.Visible = true
            else
                objects.Line.Visible = false
            end
        else
            objects.Box.Visible = false
            objects.Line.Visible = false
        end
    end
end)
